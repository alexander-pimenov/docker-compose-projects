#version: '3.8'

services:
  ##  ---------- Zookeeper ----------  ##
  zookeeper:
    image: docker.io/confluentinc/cp-zookeeper:7.0.1
    container_name: zookeeper
    restart: on-failure
    mem_limit: 300m
    environment:
      KAFKA_OPTS: >
        -Dzookeeper.extendedTypesEnabled=true
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ALLOW_ANONYMOUS_LOGIN: "yes"
      ZOOKEEPER_ADMIN_SERVER_PORT: 8191  # —É—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–æ–≤—ã–π –ø–æ—Ä—Ç –¥–ª—è AdminServer
    healthcheck:
      test: [ "CMD", "curl", "-fsSL", "http://zookeeper:8191/commands/ruok" ]
      #      test: ["CMD", "bash", "-c", "echo ruok | nc zookeeper 2181"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
      interval: 10s
      timeout: 5s
      retries: 20
    ports:
      - 22181:2181
    networks:
      - kafka-postgres-redis-net

  #  ---------- Kafka ----------
  kafka:
    image: docker.io/confluentinc/cp-kafka:7.2.0
    container_name: kafka
    restart: on-failure
    mem_limit: 1.5G
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ALLOW_PLAINTEXT_LISTENER: "yes"
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: "0"
      KAFKA_LOG4J_LOGGERS: "kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO"
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT: "40000"
      #      –° —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –Ω–µ —Ä–∞–±–æ—Ç–∞–ª ,—Ç.–µ. –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫ –∫–∞—Ñ–∫–µ –Ω–∏ –ø—Ä–æ–¥—é—Å–µ—Ä –Ω–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä:
      #      KAFKA_LISTENERS: INSIDE://0.0.0.0:9092,OUTSIDE://0.0.0.0:29092
      #      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      #      KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka:9092,OUTSIDE://localhost:29092
      #      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
      #      –° —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∑–∞—Ä–∞–±–æ—Ç–∞–ª –∏ –ø—Ä–æ–¥—é—Å–µ—Ä –∏ –∫–æ–Ω—Å—é–º–µ—Ä:
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_HOST://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      #      KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/var/lib/kafka
    #      - ./kafka-data:/var/lib/kafka:z # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç —Å host path (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å)
    healthcheck:
      test: [ "CMD-SHELL", "echo 'test-message' | kafka-console-producer --broker-list kafka:9092 --topic health-check-topic && kafka-console-consumer --bootstrap-server kafka:9092 --topic health-check-topic --from-beginning --max-messages 1 | grep 'test-message'" ]
      #      test: ["CMD", "kafka-topics", "--bootstrap-server", "kafka:9092", "--list"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
      #      test: ["CMD", "nc", "-vz", "kafka", "9092"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –Ω–æ –º–æ–∂–µ—Ç –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
      interval: 15s
      timeout: 10s
      retries: 3
    ports:
      #      - 29092:9092
      - 9092:9092
    networks:
      - kafka-postgres-redis-net

  #  ---------- Kafka-UI ----------
  kafka-ui:
    #    image: docker.io/provectuslabs/kafka-ui:latest
    image: docker.io/provectuslabs/kafka-ui:c00cb320cde844bcefbde8fc2105d65b6e725b93
    #    docker pull provectuslabs/kafka-ui:1108c760e5f0b23908f3818500b78fe57d44ce71
    container_name: kafka-ui
    restart: on-failure
    mem_limit: 400m
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: local-kafka
      #      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: localhost:9092
      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTER_0_JMXPORT: 9997
      DYNAMIC_CONFIG_ENABLED: "true"
    #    —Ç–∞–∫ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É –∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —Ç.–∫. –∫–∞—Ñ–∫–∞ —ç—Ç–æ Java –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    #    env_file:
    #      - ./kafka-ui/JAVA_OPTS
    ports:
      - 8078:8080
    networks:
      - kafka-postgres-redis-net

  ##  ---------- –ï—â–µ –æ–¥–∏–Ω Kafka-UI, –Ω–æ, –∫–∞–∫ –ø–æ –º–Ω–µ, –æ–Ω —Ö—É–∂–µ, —á–µ–º –≤–µ—Ä—Ö–Ω–∏–π ---------- ##
  #  kafdrop:
  #    image: docker.io/obsidiandynamics/kafdrop:latest
  #    container_name: kafdrop
  #    depends_on:
  #      kafka:
  #        condition: service_healthy
  #    ports:
  #      - 9000:9000
  #    environment:
  #      KAFKA_BROKERCONNECT: kafka:29092
  #      JVM_OPTS: "-Xms32M -Xmx64M"
  #    networks:
  #      - kafka-postgres-redis-net

  ## --------------------------------- Postgres --------------------------------- ##
  postgres-db:
    image: docker.io/postgres:15.3-alpine3.18
    container_name: postgres-db
    mem_limit: 1600m
    command:
      - "postgres"
      - "-c"
      - "max_connections=16"
    #      - "-p"
    #      - "6532"
    environment:
      POSTGRES_DB: url_shortener
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./init-script:/docker-entrypoint-initdb.d:Z #—Å–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
      - postgres_data:/var/lib/postgresql/data  # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ volume
    #      - ./postgres-data:/var/lib/postgresql/data:Z  # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ë–î, –≤–∞—Ä–∏–∞–Ω—Ç —Å host path (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å)
    ports:
      - 6532:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d url_shortener" ]
      #      test: [ "CMD-SHELL", "pg_isready -U postgres -p 6532 -d nsix" ]
      interval: 10s
      timeout: 10s
      retries: 30
    networks:
      - kafka-postgres-redis-net

  redis:
    image: docker.io/redis:7-alpine
    container_name: redis
    ports:
      - 6379:6379
    command: redis-server --appendonly yes
    volumes:
      # –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Redis –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ./redis-data. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤
      # –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ, –∏ –≤—ã –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –∏—Ö, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Redis —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏—Ç—Å—è –∏–ª–∏ –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø.
      # –ì–ª–∞–≤–Ω–æ–µ ‚Äî –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞–ø–∫–∏ redis-data.
      # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é volumes –∏ —Ç–æ–≥–¥–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≥–¥–µ-—Ç–æ –≤ —Å–∏—Å—Ç–µ–º–µ.
      #- ./redis-data:/data # Optional: for data persistence
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - kafka-postgres-redis-net

  # RedisInsight - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π UI
  redis-insight:
    image: docker.io/redis/redisinsight:latest
    container_name: redis-insight
    ports:
      - 5540:5540
    volumes:
      - redis_insight_data:/db
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - kafka-postgres-redis-net

  # Redis Commander - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π)
  redis-commander:
    image: docker.io/rediscommander/redis-commander:latest
    container_name: redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - 8081:8081
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - kafka-postgres-redis-net

  ## --------------------------------- Syngx ---------------------------------- ##
  #  syngx-check:
  #    image: docker-release.registry-ci.delta.sbrf.ru/ci04309835/ci04309835/snx/sbel8:syngx-2.3.0-5428-repacked-176
  #    container_name: syngx-check
  #    mem_limit: 100m
  #    depends_on:
  #      postgres-db:
  #        condition: service_healthy
  #    ports:
  #      - "8181:8181"
  #    healthcheck:
  #      test: [ "CMD", "curl", "-f", "http://syngx-check:8181" ]
  #      interval: 15s
  #      timeout: 10s
  #      retries: 50
  #      start_period: 100s
  #    volumes:
  #      - ./syngx/syngx.conf:/opt/syngx/conf/syngx.conf:z
  #    networks:
  #      - kafka-postgres-net

  ## --------------------------------- Nginx ---------------------------------- ##
  #  nginx:
  #    image: docker.io/nginx:1.19.2-alpine
  #    hostname: nginx
  #    volumes:
  #      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:z
  #    ports:
  #      - 9080:9080
  #    depends_on:
  #      - minio4
  #    networks:
  #      - kafka-postgres-net
  #    healthcheck:
  #      test: [ "CMD", "curl", "-f", "http://localhost" ]
  #      interval: 15s         # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)
  #      timeout: 10s          # –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)
  #      retries: 5            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–º–µ—Ç–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ "unhealthy"
  ##      start_period: 5s      # –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞


  ## --------------------------- Zipkin (–¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏) ---------------------------- ##
#  zipkin:
#    image: openzipkin/zipkin:latest
#    container_name: zipkin
#    mem_limit: 600M
#    environment:
#      - STORAGE_TYPE=mem
#    #      - STORAGE_TYPE=elasticsearch
#    #      - ES_HOSTS=http://elasticsearch:9200
#    ports:
#      - 9411:9411
#    networks:
#      - kafka-postgres-net

networks:
  kafka-postgres-redis-net:
    name: kafka-postgres-redis-net
    driver: bridge

#üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ named volumes:
# - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker'–æ–º
# - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ Linux)
# - –ü—Ä–æ—â–µ –±—ç–∫–∞–ø—ã (docker volume export)
# - –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
volumes:
  postgres_data:
    name: postgres_data # –î–ª—è postgres —Ä–µ–∫–æ–º–µ–Ω–¥—É—é named volume
  kafka_data:
    name: kafka_data # –î–ª—è Kafka —Ä–µ–∫–æ–º–µ–Ω–¥—É—é named volume
  redis_data:
    name: redis_data # –î–ª—è Redis —Ä–µ–∫–æ–º–µ–Ω–¥—É—é named volume
  redis_insight_data:
    name: redis_insight_data