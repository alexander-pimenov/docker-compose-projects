#version: '3.8'

services:
  ##  ---------- Zookeeper ----------  ##
  zookeeper:
    image: docker.io/confluentinc/cp-zookeeper:7.0.1
    container_name: zookeeper
    restart: on-failure
    mem_limit: 300m
    environment:
      KAFKA_OPTS: >
        -Dzookeeper.extendedTypesEnabled=true
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ALLOW_ANONYMOUS_LOGIN: "yes"
      ZOOKEEPER_ADMIN_SERVER_PORT: 8191  # —É—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–æ–≤—ã–π –ø–æ—Ä—Ç –¥–ª—è AdminServer
    healthcheck:
      test: [ "CMD", "curl", "-fsSL", "http://zookeeper:8191/commands/ruok" ]
#      test: ["CMD", "bash", "-c", "echo ruok | nc zookeeper 2181"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
      interval: 10s
      timeout: 5s
      retries: 20
    ports:
      - 22181:2181
    networks:
      - kafka-postgres-net

  #  ---------- Kafka ----------
  kafka:
    image: docker.io/confluentinc/cp-kafka:7.2.0
    container_name: kafka
    restart: on-failure
    mem_limit: 1.5G
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ALLOW_PLAINTEXT_LISTENER: "yes"
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: "0"
      KAFKA_LOG4J_LOGGERS: "kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO"
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT: "40000"
#      KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka:9092,OUTSIDE://localhost:9093
      KAFKA_LISTENERS: INSIDE://0.0.0.0:9092,OUTSIDE://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka:9092,OUTSIDE://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
#      KAFKA_LISTENERS: INSIDE://0.0.0.0:9092,OUTSIDE://0.0.0.0:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    volumes:
      - kafka_data:/var/lib/kafka
#      - ./kafka-data:/var/lib/kafka:z # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç —Å host path (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å)
    healthcheck:
      test: [ "CMD-SHELL", "echo 'test-message' | kafka-console-producer --broker-list kafka:9092 --topic health-check-topic && kafka-console-consumer --bootstrap-server kafka:9092 --topic health-check-topic --from-beginning --max-messages 1 | grep 'test-message'" ]
#      test: ["CMD", "kafka-topics", "--bootstrap-server", "kafka:9092", "--list"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
#      test: ["CMD", "nc", "-vz", "kafka", "9092"] # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –Ω–æ –º–æ–∂–µ—Ç –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
      interval: 10s
      timeout: 30s
      retries: 3
    ports:
#      - 9092:9092
      - 29092:9092
    networks:
      - kafka-postgres-net

  #  ---------- Kafka-UI ----------
  kafka-ui:
#    image: docker.io/provectuslabs/kafka-ui:latest
    image: docker.io/provectuslabs/kafka-ui:c00cb320cde844bcefbde8fc2105d65b6e725b93
#    docker pull provectuslabs/kafka-ui:1108c760e5f0b23908f3818500b78fe57d44ce71
    container_name: kafka-ui
    restart: on-failure
    mem_limit: 400m
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: local
#      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: localhost:9092
#      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:9092,localhost:9093
      KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTER_0_JMXPORT: 9997
      DYNAMIC_CONFIG_ENABLED: "true"
#    —Ç–∞–∫ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É –∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —Ç.–∫. –∫–∞—Ñ–∫–∞ —ç—Ç–æ Java –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
#    env_file:
#      - ./kafka-ui/JAVA_OPTS
    ports:
      - 8078:8080
    networks:
      - kafka-postgres-net

  ## --------------------------------- Postgres --------------------------------- ##
  postgres-db:
    image: docker.io/postgres:15.3-alpine3.18
    container_name: postgres-db
    mem_limit: 1600m
    command:
      - "postgres"
      - "-c"
      - "max_connections=16"
#      - "-p"
#      - "6432"
    environment:
      POSTGRES_DB: nsix
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./init-script:/docker-entrypoint-initdb.d:Z #—Å–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
      - postgres_data:/var/lib/postgresql/data  # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ volume
#      - ./postgres-data:/var/lib/postgresql/data:Z  # –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ë–î, –≤–∞—Ä–∏–∞–Ω—Ç —Å host path (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å)
    ports:
      - 6432:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d nsix" ]
#      test: [ "CMD-SHELL", "pg_isready -U postgres -p 6432 -d nsix" ]
      interval: 10s
      timeout: 10s
      retries: 30
    networks:
      - kafka-postgres-net

  ## --------------------------------- Migration ---------------------------------- ##
  #  migration:
  #    image: docker.io/rekib-dms-migration-job:25.1.01_96
  #    container_name: migration
  #    mem_limit: 1300m
  #    environment:
  #      POSTGRES_DB: nsix
  #      POSTGRES_HOST: postgres-db:6432
  #    volumes:
  #      - ./data-base-dictionary-secret:/vault/secrets/data-base-dictionary-secret:z
  #    command: >
  #      sh -c "
  #        java -jar app.jar --spring.liquibase.enabled=true
  #      "
  #    depends_on:
  #      postgres-db:
  #        condition: service_healthy
  #    networks:
  #      - kafka-postgres-net

  ## --------------------------------- Syngx ---------------------------------- ##
#  syngx-check:
#    image: docker-release.registry-ci.delta.sbrf.ru/ci04309835/ci04309835/snx/sbel8:syngx-2.3.0-5428-repacked-176
#    container_name: syngx-check
#    mem_limit: 100m
#    depends_on:
#      postgres-db:
#        condition: service_healthy
#    ports:
#      - "8181:8181"
#    healthcheck:
#      test: [ "CMD", "curl", "-f", "http://syngx-check:8181" ]
#      interval: 15s
#      timeout: 10s
#      retries: 50
#      start_period: 100s
#    volumes:
#      - ./syngx/syngx.conf:/opt/syngx/conf/syngx.conf:z
#    networks:
#      - kafka-postgres-net

  ## --------------------------------- Nginx ---------------------------------- ##
#  nginx:
#    image: docker.io/nginx:1.19.2-alpine
#    hostname: nginx
#    volumes:
#      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:z
#    ports:
#      - 9080:9080
#    depends_on:
#      - minio4
#    networks:
#      - kafka-postgres-net
#    healthcheck:
#      test: [ "CMD", "curl", "-f", "http://localhost" ]
#      interval: 15s         # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)
#      timeout: 10s          # –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)
#      retries: 5            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–º–µ—Ç–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ "unhealthy"
##      start_period: 5s      # –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞


  ## --------------------------- Zipkin (–¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏) ---------------------------- ##
#  zipkin:
#    image: openzipkin/zipkin:latest
#    container_name: zipkin
#    mem_limit: 600M
#    environment:
#      - STORAGE_TYPE=mem
#    #      - STORAGE_TYPE=elasticsearch
#    #      - ES_HOSTS=http://elasticsearch:9200
#    ports:
#      - 9411:9411
#    networks:
#      - kafka-postgres-net

networks:
  kafka-postgres-net:
    name: kafka-postgres-net
    driver: bridge

#üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ named volumes:
# - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker'–æ–º
# - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ Linux)
# - –ü—Ä–æ—â–µ –±—ç–∫–∞–ø—ã (docker volume export)
# - –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
volumes:
  postgres_data:
    name: postgres_data # –î–ª—è postgres —Ä–µ–∫–æ–º–µ–Ω–¥—É—é named volume
  kafka_data:
    name: kafka_data # –î–ª—è Kafka —Ä–µ–∫–æ–º–µ–Ω–¥—É—é named volume